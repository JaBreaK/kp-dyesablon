<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Banner Manager Supabase</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

  <div class="flex flex-col lg:flex-row gap-6">
    <!-- Daftar banner/kartu -->
    <div id="banner-container" class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- JS akan render di sini -->
    </div>

    <!-- Side form untuk tambah/edit -->
    <div class="w-full lg:w-80 bg-white rounded-lg shadow p-4">
      <h3 class="text-lg font-medium text-gray-800 mb-4">Tambah / Edit Banner</h3>
      <form id="banner-form" class="flex flex-col space-y-3">
        <!-- Hidden field untuk id (edit) -->
        <input type="hidden" id="banner-id" />
        <div>
          <label for="banner-nama" class="block text-sm font-medium text-gray-700">Nama Banner</label>
          <input type="text" name="nama" id="banner-nama"
                 class="mt-1 w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="Masukkan nama banner" />
        </div>
        <div>
          <label for="banner-gambar" class="block text-sm font-medium text-gray-700">Pilih Gambar (jpg/png)</label>
          <input type="file" accept="image/*" name="gambar" id="banner-gambar"
                 class="mt-1 w-full" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Preview Gambar</label>
          <img id="banner-preview" src="" alt="Preview"
               class="w-full h-32 object-cover rounded border mt-1 bg-gray-50" />
        </div>
        <div class="flex justify-end space-x-2 pt-2">
          <button type="button" id="btn-reset"
                  class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Reset</button>
          <button type="submit"
                  class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Script Supabase & logic -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ======= KONFIGURASI: Ganti sesuai project Anda =======
    const SUPABASE_URL = 'https://pmfzypvynmyotmvbgafi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtZnp5cHZ5bm15b3RtdmJnYWZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxNTcxNTgsImV4cCI6MjA2MTczMzE1OH0.NimEhbTS9Rz_GGXpEABU_rWunPB6TUN7S4ufTS7FNiM'; // <-- Ganti dengan anon key
    const BUCKET_NAME = 'images';       // bucket Supabase Storage
    const FOLDER = 'banner';            // subfolder di bucket, misal 'banner'
    const TABLE_NAME = 'banner';        // nama tabel yang menyimpan kolom id, nama, gambar
    // Fallback image jika kolom gambar kosong:
    const DEFAULT_IMAGE_URL = 'https://pmfzypvynmyotmvbgafi.supabase.co/storage/v1/object/public/images/HOME/LP-DARK-1.jpg';
    // =====================================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Elemen DOM
    const container = document.getElementById('banner-container');
    const form = document.getElementById('banner-form');
    const inputId = document.getElementById('banner-id');
    const inputNama = document.getElementById('banner-nama');
    const inputGambar = document.getElementById('banner-gambar');
    const previewImg = document.getElementById('banner-preview');
    const btnReset = document.getElementById('btn-reset');

    let banners = [];

    // Prefix public URL Supabase Storage:
    // e.g. 'https://pmfzypvynmyotmvbgafi.supabase.co/storage/v1/object/public/images/'
    const STORAGE_PUBLIC_BASE = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}/`;

    // Utility: parse path di Storage dari public URL
    // Jika URL: "https://.../storage/v1/object/public/images/banner/xxx.png"
    // Maka return: "banner/xxx.png"
    function parsePathFromUrl(url) {
      if (!url || typeof url !== 'string') return null;
      if (url.startsWith(STORAGE_PUBLIC_BASE)) {
        return url.substring(STORAGE_PUBLIC_BASE.length);
      }
      return null;
    }

    // Resolve URL gambar:
    // - Jika kosong/null: pakai DEFAULT_IMAGE_URL
    // - Jika sudah http/https: return langsung
    // - Jika path saja: bangun publicUrl via getPublicUrl
    async function resolveImageUrlAsync(gambarField) {
      if (!gambarField) return DEFAULT_IMAGE_URL;
      if (typeof gambarField === 'string' && (gambarField.startsWith('http://') || gambarField.startsWith('https://'))) {
        return gambarField;
      }
      // Jika menyimpan path saja (misal 'banner/xxx.png'), gunakan getPublicUrl:
      const { data, error } = supabase.storage.from(BUCKET_NAME).getPublicUrl(gambarField);
      if (error) {
        console.warn('Gagal getPublicUrl untuk', gambarField, error);
        return DEFAULT_IMAGE_URL;
      }
      return data.publicUrl;
    }
    // Sinkron version: jika yakin field adalah URL atau null, bisa langsung return; tetapi kita asumsikan polanya kita simpan URL.
    function resolveImageUrl(gambarField) {
      if (!gambarField) return DEFAULT_IMAGE_URL;
      if (typeof gambarField === 'string' && (gambarField.startsWith('http://') || gambarField.startsWith('https://'))) {
        return gambarField;
      }
      // Jika path tersisa, gunakan STORAGE_PUBLIC_BASE
      return STORAGE_PUBLIC_BASE + gambarField;
    }

    // 1. Fetch data banner dari tabel
    async function fetchBanners() {
      container.innerHTML = '<p class="text-gray-500">Loading...</p>';
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('*')
        .order('nama', { ascending: true });
      if (error) {
        console.error('Error fetch banner:', error);
        container.innerHTML = `<p class="text-red-500">Gagal memuat data banner: ${error.message}</p>`;
        return;
      }
      banners = data;
      renderBanners();
    }

    // 2. Render daftar banner ke DOM
    async function renderBanners() {
      container.innerHTML = '';
      if (!banners || banners.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Belum ada banner.</p>';
        return;
      }
      // Untuk performa, kita bisa resolve URL secara sync jika yakin menyimpan full URL di DB.
      banners.forEach(item => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow p-4 flex flex-col';

        // Gambar
        const img = document.createElement('img');
        // Jika di DB sudah menyimpan public URL, kita langsung pakai:
        let imgSrc = resolveImageUrl(item.gambar);
        img.src = imgSrc;
        img.alt = item.nama || 'banner';
        img.className = 'w-full h-32 object-cover rounded';
        card.appendChild(img);

        // Nama/title
        const h3 = document.createElement('h3');
        h3.className = 'mt-2 text-lg font-semibold text-gray-800';
        h3.textContent = item.nama || '(no name)';
        card.appendChild(h3);

        // Tombol edit & delete
        const btnContainer = document.createElement('div');
        btnContainer.className = 'mt-2 flex justify-end space-x-2';

        const btnEdit = document.createElement('button');
        btnEdit.className = 'px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600';
        btnEdit.textContent = 'Edit';
        btnEdit.addEventListener('click', () => openEditForm(item));
        btnContainer.appendChild(btnEdit);

        const btnDel = document.createElement('button');
        btnDel.className = 'px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600';
        btnDel.textContent = 'Hapus';
        btnDel.addEventListener('click', () => deleteBanner(item.id, item.gambar));
        btnContainer.appendChild(btnDel);

        card.appendChild(btnContainer);
        container.appendChild(card);
      });
    }

    // 3. Buka form edit: isi input, simpan URL lama di dataset
    function openEditForm(item) {
      inputId.value = item.id;
      inputNama.value = item.nama || '';
      // preview src: jika ada gambar di DB, pakai; jika kosong, DEFAULT
      previewImg.src = resolveImageUrl(item.gambar);
      inputGambar.value = '';
      // Simpan URL lama:
      form.dataset.oldUrl = item.gambar || '';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    // 4. Reset form
    function resetForm() {
      inputId.value = '';
      inputNama.value = '';
      inputGambar.value = '';
      previewImg.src = '';
      delete form.dataset.oldUrl;
    }
    btnReset.addEventListener('click', resetForm);

    // 5. Preview saat pilih file
    inputGambar.addEventListener('change', () => {
      const file = inputGambar.files[0];
      if (file) {
        previewImg.src = URL.createObjectURL(file);
      } else {
        if (form.dataset.oldUrl) {
          previewImg.src = resolveImageUrl(form.dataset.oldUrl);
        } else {
          previewImg.src = '';
        }
      }
    });

    // 6. Submit form: tambah atau edit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = inputId.value;
      const nama = inputNama.value.trim();
      const file = inputGambar.files[0];

      if (!nama) {
        alert('Nama banner harus diisi');
        return;
      }

      if (!id) {
        // Tambah baru: file wajib
        if (!file) {
          alert('Mohon pilih file gambar untuk banner baru');
          return;
        }
        try {
          await tambahBanner(nama, file);
          alert('Banner berhasil ditambahkan');
          resetForm();
          fetchBanners();
        } catch (err) {
          console.error('Error tambahBanner:', err);
          alert('Gagal tambah banner: ' + err.message);
        }
      } else {
        // Edit existing
        try {
          await editBanner(id, nama, file);
          alert('Banner berhasil diupdate');
          resetForm();
          fetchBanners();
        } catch (err) {
          console.error('Error editBanner:', err);
          alert('Gagal update banner: ' + err.message);
        }
      }
    });

    // 7. Fungsi tambahBanner
    async function tambahBanner(nama, file) {
      // Build filePath: 'banner/<safeName>-timestamp.ext'
      const fileExt = file.name.split('.').pop();
      const safeName = nama.toLowerCase()
                           .replace(/\s+/g, '-')
                           .replace(/[^a-z0-9\-]/g, '');
      const timestamp = Date.now();
      const filePath = `${FOLDER}/${safeName}-${timestamp}.${fileExt}`;

      // Upload ke Storage bucket 'images'
      const { data: uploadData, error: uploadError } = await supabase
        .storage
        .from(BUCKET_NAME)
        .upload(filePath, file, { cacheControl: '3600', upsert: false });
      if (uploadError) throw uploadError;

      // Dapatkan publicUrl
      const { data: { publicUrl }, error: urlError } = supabase
        .storage
        .from(BUCKET_NAME)
        .getPublicUrl(uploadData.path);
      if (urlError) console.warn('Gagal dapat publicUrl:', urlError);

      // Insert ke tabel banner
      const { error: insertError } = await supabase
        .from(TABLE_NAME)
        .insert({ nama, gambar: publicUrl });
      if (insertError) throw insertError;
    }

    // 8. Fungsi editBanner
    async function editBanner(id, nama, file) {
      let updateObj = { nama };
      let newPath = null;
      let newPublicUrl = null;

      if (file) {
        // Upload file baru
        const fileExt = file.name.split('.').pop();
        const safeName = nama.toLowerCase()
                             .replace(/\s+/g, '-')
                             .replace(/[^a-z0-9\-]/g, '');
        const timestamp = Date.now();
        const filePath = `${FOLDER}/${safeName}-${timestamp}.${fileExt}`;

        const { data: uploadData, error: uploadError } = await supabase
          .storage
          .from(BUCKET_NAME)
          .upload(filePath, file, { cacheControl: '3600', upsert: false });
        if (uploadError) throw uploadError;

        const { data: { publicUrl }, error: urlError } = supabase
          .storage
          .from(BUCKET_NAME)
          .getPublicUrl(uploadData.path);
        if (urlError) console.warn('Gagal dapat publicUrl new file:', urlError);

        newPath = uploadData.path;         // misal 'banner/xxx.png'
        newPublicUrl = publicUrl;          // misal 'https://.../storage/.../images/banner/xxx.png'
        updateObj.gambar = newPublicUrl;
      }

      // Update row di tabel
      const { error: updateError } = await supabase
        .from(TABLE_NAME)
        .update(updateObj)
        .eq('id', id);
      if (updateError) throw updateError;

      // Jika ada file lama dan file baru diupload, hapus file lama di Storage
      if (file && form.dataset.oldUrl) {
        const oldUrl = form.dataset.oldUrl;
        const oldPath = parsePathFromUrl(oldUrl);
        if (oldPath) {
          const { error: delErr } = await supabase
            .storage
            .from(BUCKET_NAME)
            .remove([oldPath]);
          if (delErr) console.warn('Gagal hapus file lama:', delErr);
        }
      }
    }

    // 9. Fungsi deleteBanner
    async function deleteBanner(id, gambarField) {
      if (!confirm('Yakin ingin menghapus banner ini?')) return;
      // Hapus row dari tabel
      const { error: delRecErr } = await supabase
        .from(TABLE_NAME)
        .delete()
        .eq('id', id);
      if (delRecErr) {
        console.error('Error delete record:', delRecErr);
        alert('Gagal menghapus banner: ' + delRecErr.message);
        return;
      }
      // Hapus file di Storage bila URL milik Storage
      const oldPath = parsePathFromUrl(gambarField);
      if (oldPath) {
        const { error: delFileErr } = await supabase
          .storage
          .from(BUCKET_NAME)
          .remove([oldPath]);
        if (delFileErr) console.warn('Gagal hapus file storage:', delFileErr);
      }
      alert('Banner dihapus');
      fetchBanners();
    }

    // 10. Inisialisasi: fetch data awal
    document.addEventListener('DOMContentLoaded', () => {
      fetchBanners();
    });
  </script>
</html>
